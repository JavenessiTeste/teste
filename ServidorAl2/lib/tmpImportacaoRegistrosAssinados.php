<?php
require('base.php');

$codigoEmpresa = 400;
$codigoAssociado = '';

/*
bloco importados
'54303346934', '00440479916', '20651708915', '20651708915', '01637182961',
'71363408968', '61967700982', '58546731934', '36572179915', '19053860959',
'19053860959', '19053860959', '19053860959', '26101083896', '06746579859',
'40264840682', '40264840682', '40264840682', '40264840682', '80239510925',
'73089516934', '13807287892', '53123000044', '53123000044', '23582375900',
'23582375900', '05093578908', '05093578908', '05093578908', '05093578908', '83952861987',
'83952861987', '83952861987', '73043494920', '73043494920', '73043494920', '30684676915',
'30684676915', '36339229972', '36339229972', '12437975845', '20718349920', '20718349920', '48128872168',
'03499210916', '02523517701', '02523517701', '57745668972', '57745668972', '57745668972', '75609045991',
'75609045991', '75609045991', '91789354900', '91789354900', '91789354900', '36339229972', '91789354900',
'03029128946', '93464525953', '93464525953', '93464525953', '93464525953','36741230963', 
'77560957900',
				'77560957900', '02110612983', '02110612983', '04738885995', '04738885995', '04738885995', '44573707972',
				'44573707972', '44573707972', '44573707972', '11829220829', '05643076888', '05643076888', '05643076888',
				'95396802987', '95396802987', '95396802987', '67379257900', '08066747764', '08066747764', '32403984604',
				'32403984604', '32403984604', '32403984604', '46359478900', '03612579967', '03612579967', '69960623904',
				'69960623904', '69960623904', '69960623904', '93459220910', '93459220910', '93459220910', '61088854915',
				'61088854915', '61088854915', '33217505972', '33217505972', '65411234972', '65411234972', '65411234972',
				'65411234972', '61107271991', '61107271991', '61107271991', '02461974985', '02461974985', '02461974985',
				'66647118934', '66647118934', '66647118934', '36770566915', '36770566915', '36770566915',  '73048690972',
				'06036237863', '06036237863', '02034319958', '23710446953', '18349329807',
					'36560200949',
					'36560200949',
					'36560200949',
					'62058169972',
					'62058169972',
					'62058169972',
					'32871333904',
					'53503457968',
					'53503457968',
					'53503457968',
					'53503457968',
					'02952364850',
					'02952364850',
					'50536079900',
					'50536079900',
					'50536079900',
					'01476752940',
					'01476752940',
					'01476752940',
					'56584270963',
					'56584270963',
					'56584270963',
					'29451321845',
					'29451321845',
					'13881160817',
					'83553754915',
					'83553754915',
					'83553754915',
					'83553754915',
					'30100166890',
					'86079743949',
					'86079743949',
					'04430214654',
					'56158394904',
					'56158394904',
					'02034319958',
					'26101083896',
					'02535420902',
					'79450407991',
					'79450407991',
					'79450407991',
					'16560784819',
					'16560784819',
					'18328373866',
					'00397708939',
					'66768489968',
					'66768489968',
					'66768489968',
					'16560784819',
					'64218490910',
					'64218490910',
					'64218490910',
					'64218490910',
					'48893625920',
					'15728004881',
					'15728004881',
					'15728004881',
					'15728004881',
					'15728004881',
					'01939908906',
					'01939908906',
					'72743344920',
					'72743344920',
					'72743344920',
					'72743344920',
					'86335324920',
					'08066747764',
					'36660345949',
					'36660345949',
					'36660345949',
					'12460572808',
					'04556830850',
					'08688884862',
					'04556830850',
					'04556830850',
					'01433640902', '04738885995', '06304887973', '06304887973', '08830950840',
					'08830950840', '08830950840', '08830950840', '61088854915', '14430966877', '14430966877', '14430966877',
					'12437975845',
					'43920241991',
					'43920241991',
					'02952364850', '02535420902', '93469284920', '38413612349', '84927550915',
					'84927550915', '76775070853', '76775070853', '20818122900', '20818122900', '01476752940',
					'33829738803', '30858631920', '30858631920', '06473627839', '06473627839', '06473627839', '54292824991',
					'02597255794', '33829738803', '02685410945', '02685410945', '60115327991', '36038130900',
					'36038130900',
					'82399891953',
					'52174565900',
					'13096002878',
					'42995701972',
					'42995701972',
					'78882397904',
					'49815865900',
					'86919156920',
					'86919156920',
					'05152226901',
					'03967407900',
					'03967407900',
					'02034319958',
					'00936094931',
					'67387195900',
					'67387195900',
					'67387195900',
					'48893625920',
					'08733557845',
					'08733557845',
					'08733557845',
					'08733557845',
					'34919759991',
					'34919759991',
					'34919759991',
					'30186258895',
					'04852573948',
					'04852573948',
					'90830318968',
					'90830318968',
					'09597400740',
					'09597400740',
					'29404818810',
					'29404818810',
					'86079743949',
					'86079743949',
					'29845925812',
					'09674267824',
					'04356024974',
					'95396802987',
					'84112700920',
					'84112700920',
					'84112700920',
					'97505323920',
					'97505323920',
					'66768489968',
					'47494034072',
					'47494034072',
					'00590966910',
					'00590966910',
					'84068825904',
					'30858631920',
					'36567302968',
					'07415798805',
					'94763712691',
					'94763712691',
					'94763712691',
					'53199430910',
					'53199430910',
					'29423394892',
					'00122925912',
					'48541842991',
					'48541842991',
					'48541842991',
					'48541842991',
					'48541842991',
					'05641980994',
					'05641980994',
					'03612579967',
					'36546267934',
					'33217505972',
					'93527489991',
					'93527489991',
					'26101083896',
					'06345932850',
					'06345932850',
					'06345932850',
					'06345932850',
					'52174565900',
					'52174565900',
					'04852573948',
					'61107271991',
					'32676749803',
					'28944477876',
					'28944477876',
					'00330022822',
					'12760593886',
					'12760593886',
					'12760593886',
					'00345367952',
					'00345367952',
					'03499210916',
					'80831524987',
					'80831524987',
					'80831524987',
					'80831524987',
					'65078543953',
					'65078543953',
					'27845090875',
					'55740103991',
					'55740103991',
					'93469284920',
					'02034319958',
					'02734569973',
					'03254678974',
					'72245093968',
					'19030312904',
					'19030312904',
					'00777966913',
					'00777966913',
					'04122427967',
					'04122427967',
					'04288991960',
					'04288991960',
					'04288991960',
					'04288991960',
					'55678939904',
					'55678939904',
					'01554512948',
					'44048254987',
					'44048254987',
					'44048254987',
					'95424776949',
					'53199430910',
					'05146862940',
					'93594046915',
					'93594046915',
					'93594046915',
					'93594046915',
					'90856988987',
					'52554490910',
					'29451321845',
					'02685410945',
					'61867004968',
					'61867004968',
					'48605620978',
					'55127037904',
					'55127037904',
					'55127037904',
					'84068825904',
					'84068825904',
					'04122427967',
					'20718349920',
					'56374410904',
					'56374410904',
					'53199430910',
					'04852947961',
					'50916874915',
					'50916874915',
					'50916874915',
					'47401109972',
					'47401109972',
					'26827539814',
					'26827539814',
					'87932610982',
					'03967407900',
					'87932610982',
					'18301937831',
					'18301937831',
					'00777966913',
					'64576116991',
					'84112700920',
					'48128872168',
					'05330594960',
					'05641980994',
					'01554512948',
					'01554512948',
					'02523517701',
					'27845090875',
					'29404818810',
					'66768489968',
					'61859923968',
					'87869098949',
					'87869098949',
					'87869098949',
					'87869098949',
					'52379930520',
					'52379930520',
					'30556688805',
					'30556688805',
					'30556688805',
					'16560784819',
					'10613125770',
					'22347068822',
					'35230107804',
					'35230107804',
					'26827539814',
					'20818122900',
					'21833989813',
					'21833989813',
					'78882397904',
					'61444570978',
					'61444570978',
					'61444570978',
					'36483770944',
					'36483770944',
					'36483770944',
					'36483770944',
					'02535420902',
					'96867485049',
					'96867485049',
					'96867485049',
					'96867485049',
					'03612579967',
					'09597400740',
					'04852947961',
					'87974665904',
					'87974665904',
					'87974665904',
					'54849179053',
					'54849179053',
					'54849179053',
					'54849179053',
					'04288991960',
					'59923520900',
					'59923520900',
					'59923520900',
					'59923520900',
					'01699677948',
					'01699677948',
					'01699677948',
					'01699677948',
					'01699677948',
					'33822906859',
					'64576116991',
					'78968283753',
					'78968283753',
					'04122427967',
					'12732876810',
					'12732876810',
					'12732876810',
					'62924133904',
					'62924133904',
					'53982460972',
					'61867004968',
					'28022270920',
					'28022270920',
					'06905710970',
					'30422967840',
					'30422967840',
					'30422967840',
					'00737286911',
					'00737286911',
					'00737286911',
					'00737286911',
					'02346376922',
					'36833586888',
					'36833586888',
					'33217505972',
					'87869098949',
					'02597255794',
					'70516278991',
					'70516278991',
					'70516278991',
					'70516278991',
					'03679960905',
					'35230107804',
					'02721115979',
					'59685719934',
					'59685719934',
					'46820833920',
					'46820833920',
					'46820833920',
					'46820833920',
					'36770566915',
					'99378965920',
					'99378965920',
					'99378965920',
					'03455000916',
					'03455000916',
					'03455000916',
					'03455000916',
					'32702990959',
					'32702990959',
					'58627626987',
					'58627626987',
					'58627626987',
					'95396071915',
					'95396071915',
					'95396071915',
					'02601892943',
					'02601892943',
					'01840082984',
					'01840082984',
					'02951265905',
					'02951265905',
					'02951265905',
					'02951265905',
					'02951265905',
					'29451321845',
					'03967407900',
					'11465125701',
					'22365634850',
					'22365634850',
					'22365634850',
					'31635638801',
					'78554012968',
					'78554012968',
					'78554012968',
					'03685353985',
					'05869717930',
					'60471980900',
					'60471980900',
					'64576116991',
					'55678939904',
					'65526619915',
					'65526619915',
					'32676749803',
					'00501192905',
					'00501192905',
					'33829738803',
					'05889220993',
					'05889220993',
					'73048690972',
					'99399180972',
					'99399180972',
					'02601892943',
					'79432530949',
					'79432530949',
					'77895975900',
					'70088519953',
					'70088519953',
					'70088519953',
					'77895975900',
					'16175321855',
					'16175321855',
					'16175321855',
					'04412248909',
					'04412248909',
					'91804671991',
					'91804671991',
					'91804671991',
					'91804671991',
					'53863585968',
					'53863585968',
					'30856104809',
					'70088519953',
					'77895975900',
					'36833586888',
					'04386161970',
					'04386161970',
					'04386161970',
					'56445091920',
					'56445091920',
					'56445091920',
					'56445091920',
					'90849710944',
					'04074226928',
					'48605620978',
					'03691994997',
					'03691994997',
					'03691994997',
					'10613125770',
					'10613125770',
					'64082083987',
					'03111244962',
					'03111244962',
					'03111244962',
					'22214339809',
					'22214339809',
					'22214339809',
					'81080654968',
					'81080654968',
					'00592736903',
					'00592736903',
					'00592736903',
					'00592736903',
					'73090395991',
					'73090395991',
					'73090395991',
					'73090395991',
					'53508890953',
					'53508890953',
					'87869098949',
					'95910530887',
					'95910530887',
					'08809800958',
					'08578841905',
					'06201521844',
					'06201521844',
					'04940461980',
					'42213029687',
					'42213029687',
					'04455504907',
					'36596655920',
					'44935439904',
					'44935439904',
					'59186470825',
					'59186470825',
					'42639743872',
*/

$queryBenef = "select * from vnd1000_on
inner join vnd1002_on on (vnd1000_on.codigo_associado = vnd1002_on.codigo_associado)
left outer join ps1000 on (vnd1000_on.numero_cpf = ps1000.numero_cpf)
where ps1000.codigo_associado is null and vnd1002_on.chave_doc_clicksign in (
	'1f88b98c-a100-4078-9824-0ed9d39b057f','6a68a640-036a-4c27-9bce-ac73bcc7a6ba','25494fe8-5082-492d-aba3-8bcb2b268f89','1f88b98c-a100-4078-9824-0ed9d39b057f','e3b8a9f0-236c-4865-b821-7e9d8ce6222d','73aadead-24e4-42b8-a84f-8d81fff5dd48','1f88b98c-a100-4078-9824-0ed9d39b057f','6a68a640-036a-4c27-9bce-ac73bcc7a6ba','1f88b98c-a100-4078-9824-0ed9d39b057f','1f88b98c-a100-4078-9824-0ed9d39b057f','6a68a640-036a-4c27-9bce-ac73bcc7a6ba','6a68a640-036a-4c27-9bce-ac73bcc7a6ba','6a68a640-036a-4c27-9bce-ac73bcc7a6ba','e3b8a9f0-236c-4865-b821-7e9d8ce6222d')";

$resBenef = jn_query($queryBenef);
$i = 0;
while($rowBenef = jn_fetch_object($resBenef)){	
	$codigoAssociado = $rowBenef->CODIGO_ASSOCIADO;		
	importaTitular($codigoAssociado);	
	
	$i++;
}

pr($i);
pr('PARAR FORMULÁRIO TEMPORÁRIO',true);

if($nomeEvento == 'sign'){
	$queryAssoc  = ' SELECT * FROM VND1000_ON ';
	$queryAssoc .= ' INNER JOIN VND1002_ON ON (VND1000_ON.CODIGO_ASSOCIADO = VND1002_ON.CODIGO_ASSOCIADO)';
	$queryAssoc .= ' WHERE VND1002_ON.CHAVE_DOC_CLICKSIGN =' . aspas($codigoClickSign);
	$queryAssoc .= ' AND VND1000_ON.DESCRICAO_OBSERVACAO LIKE "%APUEL%"';
	$resAssoc = jn_query($queryAssoc);
	if($rowAssoc = jn_fetch_object($resAssoc)){
		$codigoAssociado = $rowAssoc->CODIGO_ASSOCIADO;		
		importaTitular($codigoAssociado);
	}
}



function importaTitular($codigoAssociado){
	global $codigoEmpresa;
	
	$codigoSequencial = jn_gerasequencial('PS1000');
	$codigoTitularGerado = '01'.substr($codigoEmpresa, 0, 3).str_pad(substr($codigoSequencial, 0, 7), 7, "0", STR_PAD_LEFT).'000';
	
	$campos = ' CODIGO_PLANO, CODIGO_TABELA_PRECO, NOME_ASSOCIADO, DATA_NASCIMENTO, DATA_ADMISSAO, DATA_DIGITACAO, SEXO, NOME_MAE, ';
	$campos .= ' TIPO_ASSOCIADO, CODIGO_PARENTESCO, NUMERO_CPF, NUMERO_RG, NATUREZA_RG, ORGAO_EMISSOR_RG, ';	
	$campos .= ' CODIGO_CNS, NUMERO_DECLARACAO_NASC_VIVO, DESCRICAO_OBSERVACAO ';	
	
	$queryInsertPS1000 = "insert into Ps1000(CODIGO_EMPRESA,
											 CODIGO_ASSOCIADO,
											 CODIGO_TITULAR,
											 CODIGO_SEQUENCIAL,
											 CODIGO_ANTIGO,											 
											 NUMERO_DEPENDENTE,".
											 $campos.")
						 select ".aspas($codigoEmpresa).",".
								  aspas($codigoTitularGerado).",".
								  aspas($codigoTitularGerado).",".
								  aspas($codigoSequencial).",".
								  aspas($codigoAssociado).","
								  ."0,".								  
								  $campos." FROM VND1000_ON WHERE CODIGO_ASSOCIADO = ".aspas($codigoAssociado);	

	
	if(!jn_query($queryInsertPS1000)){
		echo 'Erro: ';
		pr($queryInsertPS1000);
		exit;
	}
	
	importaEnderecoAssociado($codigoEmpresa,$codigoTitularGerado,$codigoAssociado);
	importaContratoAssociado($codigoTitularGerado,$codigoAssociado);
	importaTelefoneAssociado($codigoTitularGerado,$codigoAssociado);

	$queryDep =' SELECT CODIGO_ASSOCIADO FROM VND1000_ON WHERE TIPO_ASSOCIADO='.aspas('D').' and CODIGO_TITULAR ='.aspas($codigoAssociado);
	$resDep  = jn_query($queryDep);
	
	$i=1;
	while($rowDep  = jn_fetch_object($resDep)){
		importaDependente($codigoEmpresa,$codigoTitularGerado,$rowDep->CODIGO_ASSOCIADO,$codigoSequencial,$i);
		$i++;
	}
	
	atualizaProposta($codigoAssociado);
	
	return $codigoTitularGerado; 	
	
}

function importaDependente($codigoEmpresa,$codigoTitularGerado,$codigoAssociado,$codigoSequencial,$numeroDependente){
	
	$codigoAssociadoGerado = '01'.substr($codigoEmpresa, 0, 3).str_pad(substr($codigoSequencial, 0, 7), 7, "0", STR_PAD_LEFT).str_pad(substr($numeroDependente, 0, 2), 2, "0", STR_PAD_LEFT).'0';
	
	$campos  = ' CODIGO_PLANO, CODIGO_TABELA_PRECO, NOME_ASSOCIADO, DATA_NASCIMENTO, DATA_ADMISSAO, DATA_DIGITACAO, SEXO, NOME_MAE, ';
	$campos .= ' TIPO_ASSOCIADO, CODIGO_PARENTESCO, NUMERO_CPF, NUMERO_RG, NATUREZA_RG, ORGAO_EMISSOR_RG, ';	
	$campos .= ' CODIGO_CNS, NUMERO_DECLARACAO_NASC_VIVO, DESCRICAO_OBSERVACAO ';	
	
	$queryInsertPS1000 = "INSERT INTO PS1000(CODIGO_EMPRESA,
											 CODIGO_ASSOCIADO,
											 CODIGO_TITULAR,
											 CODIGO_SEQUENCIAL,
											 CODIGO_ANTIGO,											 
											 NUMERO_DEPENDENTE,".
											 $campos.")
						 select ".aspas($codigoEmpresa).",".
								  aspas($codigoAssociadoGerado).",".
								  aspas($codigoTitularGerado).",".
								  aspas($codigoSequencial).",".
								  aspas($codigoAssociado).",".								  
								  aspas($numeroDependente).",".
								  $campos." FROM VND1000_ON WHERE CODIGO_ASSOCIADO = ".aspas($codigoAssociado);
	
	if(!jn_query($queryInsertPS1000)){
		echo 'Erro: ';
		pr($queryInsertPS1000);
		exit;
	}
}

function importaEnderecoAssociado($codigoEmpresa,$codigoAssociadoGerado,$codigoAssociado){

	$campos = 'ENDERECO, BAIRRO, CIDADE, CEP, ESTADO, ENDERECO_EMAIL ';
	
	$queryInsertPS1001 = " 	INSERT INTO PS1001(
								CODIGO_EMPRESA,
								CODIGO_ASSOCIADO,
								".$campos.")
							SELECT ".
								aspas($codigoEmpresa).",".
								aspas($codigoAssociadoGerado).",".
								$campos.
							" FROM VND1001_ON WHERE CODIGO_ASSOCIADO = ".aspas($codigoAssociado);

	
	if(!jn_query($queryInsertPS1001)){
		echo 'Erro: ';
		pr($queryInsertPS1001);
		exit;
	}

}

function importaContratoAssociado($codigoAssociadoGerado,$codigoAssociado){

	$campos = 'NUMERO_CONTRATO, FLAG_DEBITO_AUTOMATICO, CODIGO_BANCO, NUMERO_AGENCIA, NUMERO_CONTA';
		
	$queryInsertPS1002 = "	INSERT INTO PS1002(
								CODIGO_ASSOCIADO,
								DIA_VENCIMENTO, ".
								$campos.")
							SELECT ".
								aspas($codigoAssociadoGerado). "," .
								aspas('01'). "," .
								$campos." 
							FROM VND1001_ON WHERE CODIGO_ASSOCIADO = ".aspas($codigoAssociado);

	
	if(!jn_query($queryInsertPS1002)){
		echo 'Erro: ';
		pr($queryInsertPS1002);
		exit;
	}
	

}

function importaTelefoneAssociado($codigoAssociadoGerado,$codigoAssociado){
	
	$queryInsertPS1006 = "	INSERT INTO PS1006 (								
								CODIGO_ASSOCIADO,
								INDICE_TELEFONE,
								CODIGO_AREA,
								NUMERO_TELEFONE)
							SELECT ".
								aspas($codigoAssociadoGerado).",".
								aspas('1').",".
								" substring(NUMERO_TELEFONE_01 from 2 for 2)" ."," .
								" substring(NUMERO_TELEFONE_01 from 6 for 14)" .
								" FROM VND1001_ON WHERE CODIGO_ASSOCIADO = ".aspas($codigoAssociado);
								" AND substring(NUMERO_TELEFONE_01 from 6 for 14) IS NOT NULL ";

	if(!jn_query($queryInsertPS1006)){
		echo 'Erro: ';
		pr($queryInsertPS1006);	
		exit;
	}
}

function atualizaProposta($codigoTitular){
	jn_query('UPDATE VND1000_ON SET ULTIMO_STATUS = ' . aspas('CONCLUIDO') . ' WHERE CODIGO_TITULAR = ' . aspas($codigoTitular));
}
?>